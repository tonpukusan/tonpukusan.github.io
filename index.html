<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>マルチSNS投稿ハブ（Amazon/Rakuten/Yahoo対応＋画像ペースト）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body{
    font-family:system-ui,sans-serif;
    margin:0;
    padding:14px;
    background:#fff;
  }
  .container{ max-width:600px; margin:auto; }

  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }
  .topbar h2{ margin:0; font-size:1.05rem; }
  .icon-btn{
    width:auto;
    padding:6px 10px;
    font-size:1rem;
    border-radius:10px;
    border:1px solid #ddd;
    background:#f7f7f7;
    cursor:pointer;
  }

  details.advanced{
    border:1px solid #ddd;
    border-radius:10px;
    padding:8px 10px;
    margin-bottom:10px;
    background:#fff;
  }
  details.advanced summary{ cursor:pointer; font-size:.95rem; color:#333; }

  textarea,input[type="text"]{
    width:100%;
    padding:10px;
    font-size:1rem;
    margin:10px 0;
    box-sizing:border-box;
  }
  textarea{ height:120px; }

  button{
    padding:10px 12px;
    margin:6px 0;
    font-size:1rem;
    cursor:pointer;
    width:100%;
    border-radius:12px;
    border:1px solid #ddd;
    background:#fff;
  }
  .btn-small{ padding:8px 10px; font-size:.95rem; }
  .btn-primary{ font-weight:700; border-color:#bbb; background:#f3f3f3; }
  .btn-danger{ background:#ff4d4d; color:#fff; border-color:#ff4d4d; }

  .image-box{
    border:1px solid #ccc;
    border-radius:10px;
    padding:8px 10px;
    min-height:56px;
    font-size:.85rem;
    color:#555;
    background:#fafafa;
    overflow:auto;
    box-sizing:border-box;
  }
  .image-box img{ max-width:100%; height:auto; display:block; margin-bottom:6px; }

  .actionbar{
    position:sticky;
    bottom:0;
    background:#fff;
    padding:10px 0 6px;
    border-top:1px solid #ddd;
    margin-top:10px;
  }
  .actionbar .row{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px;
    align-items:stretch;
  }
  .actionbar .row + .row{ margin-top:8px; }

  /* SNSボタンは最初から表示 */
  #snsButtons{ display:block; margin-top:10px; }
  .sns-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px;
  }
  .sns-btn{
    margin:0;
    padding:10px 8px;
    font-size:1rem;
    width:100%;
    border-radius:12px;
  }

  body{ padding-bottom:180px; }
</style>
</head>

<body>
<div class="container">

  <div class="topbar">
    <h2>PostHub</h2>
    <button id="helpBtn" class="icon-btn" type="button">ⓘ</button>
  </div>

  <details class="advanced" id="advancedBox">
    <summary>詳細</summary>

    <input type="text" id="urlInput" placeholder="URLだけ貼る（保険）">
    <button id="readClipboard" class="btn-small" style="display:none;">クリップボードから読み込む</button>
  </details>

  <button id="generate" class="btn-small">投稿文を生成</button>

  <textarea id="text" placeholder="本文（共有で入ります。追記してOK）"></textarea>

  <div id="imageBox" class="image-box">
    画像をペースト（Ctrl+V）またはドラッグ＆ドロップ（任意）
  </div>

  <div class="actionbar">
    <div class="row">
      <button id="clearDraft" style="display:none;background:#eee;">下書きクリア</button>
      <button id="closeAll" class="btn-danger">すべて閉じる</button>
    </div>

    <!-- SNSボタンは常時表示 -->
    <div id="snsButtons">
      <div class="sns-grid">
        <button class="sns-btn" id="btnX">X</button>
        <button class="sns-btn" id="btnInstagram">Instagram</button>
        <button class="sns-btn" id="btnThreads">Threads</button>
        <button class="sns-btn" id="btnBsky">Bluesky</button>
        <button class="sns-btn" id="btnFb">Facebook</button>
        <button class="sns-btn" id="btnPinterest">Pinterest</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =============================
   共通判定ユーティリティ
============================= */
const AMAZON_TAG = "yusatosh-22";

// X用 ValueCommerce sid/pid（現状）
const VC_SID_X = "3672888";
const VC_PID_X = "888362937";

// Instagram用 sid/pid は未確定なので仮（コメントアウトで後で差し替え）
// const VC_SID_IG = "YOUR_INSTAGRAM_SID";
// const VC_PID_IG = "YOUR_INSTAGRAM_PID";

/**
 * URL抽出（堅牢化）
 * - 末尾に付きやすい句読点・括弧・引用符などを除去
 * - URLとして parse できないものは落とす（ただし“軽く”）
 */
function cleanupUrlCandidate(s){
  let t = (s || "").trim();
  // よく巻き込む終端文字を削る（繰り返し対応）
  // 例: "https://example.com/abc),"
  while (/[)\]}>、。.,!?:;"'’”」》】]+$/.test(t)) {
    t = t.replace(/[)\]}>、。.,!?:;"'’”」》】]+$/, "");
  }
  return t;
}

function extractUrls(text){
  const src = (text || "");
  const hits = src.match(/https?:\/\/[^\s]+/ig) || [];
  const cleaned = [];
  for(const h of hits){
    const c = cleanupUrlCandidate(h);
    if(!c) continue;
    try{
      // URLとして成立するものだけ採用（極端に厳密にはしない）
      new URL(c);
      cleaned.push(c);
    }catch(e){
      // parse失敗でも「元のまま入れた方が良い」ケースがあるので完全には捨てない
      // ただし cleanup後が空or短すぎは捨てる
      if(c.length >= 8) cleaned.push(c);
    }
  }
  return cleaned;
}

function extractFirstUrl(text){
  return extractUrls(text)[0] || "";
}

function isValueCommerce(url){
  return !!url && url.includes("ck.jp.ap.valuecommerce.com/servlet/");
}
function hasAmazonTag(url){
  return /[?&]tag=/.test(url);
}
function hasRakutenAff(url){
  return url.includes("rafcid=") ||
         url.includes("scid=af_") ||
         url.includes("hb.afl.rakuten.co.jp") ||
         url.includes("a.r10.to");
}
function isAmazon(url){
  return /amazon\.(co\.jp|jp|asia)/i.test(url) || /amzn\.(to|asia)/i.test(url);
}
function isRakuten(url){
  return /rakuten\.(co\.jp|ne\.jp)/i.test(url) || url.includes("a.r10.to") || url.includes("hb.afl.rakuten.co.jp");
}
function isYahoo(url){
  return url.includes("shopping.yahoo.co.jp") ||
         url.includes("store.shopping.yahoo.co.jp") ||
         url.includes("yahoo.jp/");
}
function isBlogUrl(url){
  if(!url) return false;
  return url.startsWith("https://www.small-fishing.com/") ||
         url.startsWith("https://tonpuku3fishing.blogspot.com") ||
         url.startsWith("https://fishingtonpuku.blogspot.com/");
}

function isAmznShort(url){
  return /^https?:\/\/amzn\.(to|asia)\//i.test(url || "");
}
function isAmazonAsiaDomain(url){
  // 「amzn.asia」「amazon.asia」のみ追跡対象（要件）
  try{
    const u = new URL(url);
    const h = (u.host || "").toLowerCase();
    return h === "amzn.asia" || h.endsWith(".amzn.asia") || h === "amazon.asia" || h.endsWith(".amazon.asia");
  }catch(e){
    return false;
  }
}
function isAmazonCoJp(url){
  try{
    const u = new URL(url);
    const h = (u.host || "").toLowerCase();
    return h === "www.amazon.co.jp" || h === "amazon.co.jp";
  }catch(e){
    return false;
  }
}
function extractAsin(url){
  if(!url) return "";
  const m =
    url.match(/\/dp\/([A-Z0-9]{10})/i) ||
    url.match(/\/gp\/product\/([A-Z0-9]{10})/i);
  return m ? m[1].toUpperCase() : "";
}

function isAndroidApp(){
  return typeof window.Android !== "undefined" &&
         typeof window.Android.copyToClipboard === "function" &&
         typeof window.Android.saveDraft === "function" &&
         typeof window.Android.clearDraft === "function";
}

/* =============================
   A方式：Android側でURL解決（resolveUrlAsync）
   - JS側で Promise 化して generate 時に使う
============================= */
function canResolveByAndroid(){
  return typeof window.Android !== "undefined" &&
         typeof window.Android.resolveUrlAsync === "function";
}

// Android側が呼ぶ：window.__posthubResolveCallback(reqId, resolvedUrl)
window.__posthubResolveDispatch = window.__posthubResolveDispatch || {};
window.__posthubResolveCallback = function(reqId, resolvedUrl){
  const fn = window.__posthubResolveDispatch && window.__posthubResolveDispatch[reqId];
  if(fn){
    delete window.__posthubResolveDispatch[reqId];
    fn(resolvedUrl || "");
  }
};

function resolveUrlByAndroid(url, timeoutMs = 4000){
  return new Promise((resolve) => {
    if(!canResolveByAndroid()) return resolve(url);

    const reqId = "r_" + Date.now() + "_" + Math.random().toString(16).slice(2);

    const timer = setTimeout(() => {
      // タイムアウトしたらフォールバック
      if(window.__posthubResolveDispatch && window.__posthubResolveDispatch[reqId]){
        delete window.__posthubResolveDispatch[reqId];
      }
      resolve(url);
    }, timeoutMs);

    window.__posthubResolveDispatch[reqId] = (resolved) => {
      clearTimeout(timer);
      resolve(resolved || url);
    };

    try{
      window.Android.resolveUrlAsync(url, reqId);
    }catch(e){
      clearTimeout(timer);
      delete window.__posthubResolveDispatch[reqId];
      resolve(url);
    }
  });
}

function hasTag(text, tag){
  return new RegExp("(^|\\s)" + tag.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + "(?=\\s|$)", "m").test(text || "");
}

/* =============================
   初期化
============================= */
(function(){
  let winX=null, winThreads=null, winBsky=null, winFb=null;

  const textarea=document.getElementById("text");
  const urlInput=document.getElementById("urlInput");
  const imageBox=document.getElementById("imageBox");

  const isAndroid = /Android/.test(navigator.userAgent);
  const inAndroidApp = isAndroidApp();

  // ヘルプ
  const helpBtn = document.getElementById("helpBtn");
  if(helpBtn){
    helpBtn.addEventListener("click", () => {
      alert(
        "使い方：\n" +
        "1) 共有→本文が入る\n" +
        "2) 必要なら追記して「投稿文を生成」（URL整形/タグ付与）\n" +
        "3) SNSボタンを押すと本文がコピー＆下書き保存されます\n" +
        "4) 各SNS側で貼り付け\n\n" +
        "ValueCommerceリンクは投稿先に制限があります。"
      );
    });
  }

  // 下書き（Webのみ localStorage）
  const DRAFT_KEY = "posthub_draft_v3";
  function saveDraftWeb(text){
    try { localStorage.setItem(DRAFT_KEY, text); } catch(e) {}
  }
  function loadDraftWeb(){
    try { return localStorage.getItem(DRAFT_KEY) || ""; } catch(e){ return ""; }
  }
  function clearDraftWeb(){
    try { localStorage.removeItem(DRAFT_KEY); } catch(e) {}
  }

  // URLパラメータ
  const params=new URLSearchParams(location.search);
  const textParam=params.get("text")||"";
  const sharedUrl=params.get("url")||"";
  const sharedText=params.get("text")||"";
  const sharedTitle=params.get("title")||"";

  // 初期表示
  (function initTextarea(){
    if(textParam){
      textarea.value = textParam;
      return;
    }
    if(sharedTitle || sharedText){
      let combined="";
      if(sharedTitle) combined+=sharedTitle;
      if(sharedText){
        if(combined) combined+="\n";
        combined+=sharedText;
      }
      textarea.value=combined;
      return;
    }
    if(!inAndroidApp){
      const d = loadDraftWeb();
      if(d) textarea.value = d;
    }
  })();

  if(sharedUrl){
    urlInput.value=sharedUrl;
  }

  // Androidでは「すべて閉じる」を隠す
  if (isAndroid) {
    const closeBtn = document.getElementById("closeAll");
    if (closeBtn) closeBtn.style.display = "none";
  }

  // Androidだけ「下書きクリア」を表示
  const clearBtn = document.getElementById("clearDraft");
  if (isAndroid && clearBtn) {
    clearBtn.style.display = "block";
    clearBtn.addEventListener("click", () => {
      textarea.value = "";
      urlInput.value = "";

      if(inAndroidApp){
        try { window.Android.clearDraft(); } catch(e){}
      }else{
        clearDraftWeb();
      }
      alert("下書きをクリアしました");
    });
  }

  /* =============================
     クリップボード読み込み
     - Androidアプリ内：Android.readClipboard()
     - Web：navigator.clipboard.readText()
  ============================= */
  if (isAndroid) {
    const readBtn = document.getElementById("readClipboard");
    if(readBtn) readBtn.style.display = "block";
  }

  const readClipboardBtn = document.getElementById("readClipboard");
  if(readClipboardBtn){
    readClipboardBtn.addEventListener("click", async () => {
      if(inAndroidApp && typeof window.Android.readClipboard === "function"){
        try{
          const t = window.Android.readClipboard() || "";
          textarea.value = t;
          return;
        }catch(e){
          // fallthrough
        }
      }
      try{
        const t = await navigator.clipboard.readText();
        textarea.value = t || "";
      }catch(e){
        alert(
          "クリップボードを読み取れませんでした。\n" +
          "原因：ブラウザ/OSの制限で readText が拒否されることがあります。\n" +
          "対策：Androidアプリ内では readClipboard を使う構成にしています。"
        );
      }
    });
  }

  /* =============================
     生成用：Amazon/Rakuten/Yahoo
============================= */
  function cleanAmazonTitle(title){
    if(!title) return "";
    title = title.replace(/^Amazon\s*\|\s*/i, "");
    title = title.replace(/^Amazon\.co\.jp:\s*/i, "");
    title = title.replace(/\s*:\s*[^:]+$/i, "");
    let parts = title.split("|").map(s => s.trim());
    let product = parts[0] || "";
    let maker   = parts[1] || "";
    if (maker && product.includes(maker)) return product;
    if (maker) return maker + " " + product;
    return product;
  }

  function overwriteAmazonTagToMine(url){
    try{
      const u = new URL(url);
      // 既にtagがあっても set なので重複しない（上書き）
      u.searchParams.set("tag", AMAZON_TAG);
      return u.toString();
    }catch(e){
      return url;
    }
  }

  function normalizeAmazonCoJp(url){
    // amazon.co.jp でASIN取れたら dp/ASIN?tag= に正規化
    const asin = extractAsin(url);
    if(asin){
      return "https://www.amazon.co.jp/dp/" + asin + "?tag=" + AMAZON_TAG;
    }
    // ASIN取れないなら、そのURLにtagを set（重複しない）
    return overwriteAmazonTagToMine(url);
  }

  async function generateAmazonAffiliateUrl(originalUrl){
    if(!originalUrl) return originalUrl;

    // 1) amzn.to は追跡しない＆いじらない（要件）
    if(/^https?:\/\/amzn\.to\//i.test(originalUrl)) return originalUrl;

    // 2) amazon.asia / amzn.asia / amazon.asia は解決してから
    let url = originalUrl;
    if(isAmazonAsiaDomain(originalUrl)){
      const resolved = await resolveUrlByAndroid(originalUrl);

      // 解決不能（または同一のまま）なら警告
      if((resolved || "") === originalUrl){
        alert("短縮URLを解決できませんでした（amzn.asia / amazon.asia）。そのまま投稿文に残します。");
        return originalUrl;
      }
      url = resolved;
    }

    // 3) 解決後に amazon.co.jp なら正規化＆tag付与
    if(isAmazonCoJp(url)){
      return normalizeAmazonCoJp(url);
    }

    // 4) amazon.co.jp 以外に落ちたら、無理に tag を付けない（安全側）
    return url;
  }

  function generateRakutenLink(url){
    if(!isRakuten(url)) return null;
    if(hasRakutenAff(url)) return url;
    return url + (url.includes("?") ? "&" : "?") +
           "scid=af_pc_etc&rafcid=15844848.ec827d24.15844849.84443345";
  }

  function generateYahooLink(url){
    if(url.includes("yahoo.jp/")) return url;
    if(url.includes("store.shopping.yahoo.co.jp") || url.includes("shopping.yahoo.co.jp")){
      return "https://ck.jp.ap.valuecommerce.com/servlet/referral" +
        "?sid=" + VC_SID_X + "&pid=" + VC_PID_X + "&vc_url=" + encodeURIComponent(url);
    }
    return null;
  }

  function replaceFirstUrl(text, newUrl){
    // 互換維持のため：最初に見つかったURL（簡易regex）を置換
    // ※抽出は堅牢化したが、置換の“対象の考え方”は現状に寄せる
    return (text || "").replace(/https?:\/\/[^\s]+/i, newUrl);
  }

  function buildRequiredTags(url){
    const tags = [];
    if(isBlogUrl(url)) tags.push("#ブログ過去記事");

    if(isAmazon(url)){
      tags.push("#密林偵察", "#Amazonセール情報", "#PR");
    }else if(isRakuten(url)){
      tags.push("#楽天偵察", "#PR");
    }else if(isYahoo(url)){
      tags.push("#Yahoo偵察", "#PR");
    }
    return tags;
  }

  function applyTagsPreservingBody(originalText, tags){
    let t = originalText || "";
    const missing = tags.filter(tag => !hasTag(t, tag));
    if(missing.length === 0) return t;
    return missing.join(" ") + "\n" + t;
  }

  // ★生成ボタンで「amazon.asia/amzn.asiaを解決→正規化→tag」
  const genBtn = document.getElementById("generate");
  if(genBtn){
    genBtn.addEventListener("click", async () => {
      let raw = textarea.value || "";
      let url = extractFirstUrl(raw);
      if(!url) url = (urlInput.value || "").trim();
      if(!url) return;

      let affUrl = url;

      if(isAmazon(url)){
        // A方式：amazon.asia/amzn.asia のみ解決して amazon.co.jp なら正規化+tag
        affUrl = await generateAmazonAffiliateUrl(url);
      }else if(isRakuten(url)){
        affUrl = generateRakutenLink(url) || url;
      }else if(isYahoo(url)){
        affUrl = generateYahooLink(url) || url;
      }

      if(affUrl && affUrl !== url){
        raw = replaceFirstUrl(raw, affUrl);
      }

      const tags = buildRequiredTags(url);
      raw = applyTagsPreservingBody(raw, tags);

      textarea.value = raw;
    });
  }

  /* =============================
     VC制限：X/Instagram以外はNG（堅牢化）
     - 本文先頭URLだけでなく、本文内の全URL + urlInput をチェック
============================= */
  function collectAllCandidateUrls(){
    const text = textarea.value || "";
    const urls = extractUrls(text);
    const u2 = (urlInput.value || "").trim();
    if(u2) urls.push(cleanupUrlCandidate(u2));
    // 重複排除（順序維持）
    const seen = new Set();
    const uniq = [];
    for(const u of urls){
      if(!u) continue;
      if(seen.has(u)) continue;
      seen.add(u);
      uniq.push(u);
    }
    return uniq;
  }

  function guardValueCommerceOrAlert(targetSnsName){
    const text = textarea.value || "";
    const urls = collectAllCandidateUrls();
    const hasVC = urls.some(u => isValueCommerce(u));

    if(!hasVC) return {ok:true, urls, text};

    const allow = (targetSnsName === "x" || targetSnsName === "instagram");
    if(!allow){
      alert("ValueCommerceのURLはこのSNSでは投稿できません。");
      return {ok:false, urls, text};
    }
    return {ok:true, urls, text};
  }

  function replaceVcSidPidForInstagramIfNeeded(text){
    const url = extractFirstUrl(text);
    if(!isValueCommerce(url)) return text;

    // sid/pid 置換先が未確定なので、ここは後で有効化してください
    // try{
    //   const u = new URL(url);
    //   if(u.searchParams.get("sid") === VC_SID_X) u.searchParams.set("sid", VC_SID_IG);
    //   if(u.searchParams.get("pid") === VC_PID_X) u.searchParams.set("pid", VC_PID_IG);
    //   const replaced = u.toString();
    //   return replaceFirstUrl(text, replaced);
    // }catch(e){
    //   return text;
    // }
    return text;
  }

  /* =============================
     SNSボタン押下時の共通処理
     - コピーはSNSボタン押下時
     - 下書き保存も同タイミング
============================= */
  function backupAndCopy(textToCopy){
    if(inAndroidApp){
      try{ window.Android.saveDraft(textToCopy); }catch(e){}
    }else{
      saveDraftWeb(textToCopy);
    }

    if(inAndroidApp){
      try{ window.Android.copyToClipboard(textToCopy); return; }catch(e){}
    }

    navigator.clipboard.writeText(textToCopy).catch(()=>{
      // サイレント失敗をやめる（運用で困るので）
      alert("クリップボードへのコピーに失敗しました。ブラウザの権限/設定をご確認ください。");
    });
  }

  function safeWindowOpen(url, name){
    // noopener/noreferrer で opener を切る（reverse tabnabbing対策）
    const w = window.open(url, name, "noopener,noreferrer");
    if(w) { try{ w.opener = null; }catch(e){} }
    return w;
  }

  function openOrPopup(url, winRefName){
    if(inAndroidApp){
      location.href = url;
      return;
    }
    let w = null;
    if(winRefName === "X") w = winX;
    if(winRefName === "IG") w = null;
    if(winRefName === "TH") w = winThreads;
    if(winRefName === "BSKY") w = winBsky;
    if(winRefName === "FB") w = winFb;

    if(!w || w.closed){
      w = safeWindowOpen(url, "SNS_" + winRefName);
    }else{
      try{ w.location.href = url; w.focus(); }
      catch(e){ try{ w.close(); }catch(_){} w = safeWindowOpen(url, "SNS_" + winRefName); }
    }

    if(winRefName === "X") winX = w;
    if(winRefName === "TH") winThreads = w;
    if(winRefName === "BSKY") winBsky = w;
    if(winRefName === "FB") winFb = w;
  }

  // X
  const btnX = document.getElementById("btnX");
  if(btnX){
    btnX.onclick = () => {
      const g = guardValueCommerceOrAlert("x");
      if(!g.ok) return;

      const text = textarea.value || "";
      backupAndCopy(text);

      const url = "https://x.com/intent/post?text=" + encodeURIComponent(text);
      openOrPopup(url, "X");
    };
  }

  // Instagram
  const btnIG = document.getElementById("btnInstagram");
  if(btnIG){
    btnIG.onclick = () => {
      const g = guardValueCommerceOrAlert("instagram");
      if(!g.ok) return;

      let text = textarea.value || "";
      text = replaceVcSidPidForInstagramIfNeeded(text);

      backupAndCopy(text);
      openOrPopup("https://www.instagram.com/", "IG");
    };
  }

  // Threads（VCはNG）
  const btnThreads = document.getElementById("btnThreads");
  if(btnThreads){
    btnThreads.onclick = () => {
      const g = guardValueCommerceOrAlert("threads");
      if(!g.ok) return;

      const text = textarea.value || "";
      backupAndCopy(text);

      openOrPopup("https://www.threads.net/intent/post", "TH");
    };
  }

  // Bluesky（VCはNG）
  const btnB = document.getElementById("btnBsky");
  if(btnB){
    btnB.onclick = () => {
      const g = guardValueCommerceOrAlert("bsky");
      if(!g.ok) return;

      const text = textarea.value || "";
      backupAndCopy(text);

      openOrPopup("https://bsky.app", "BSKY");
    };
  }

  // Facebook（VCはNG）
  const btnF = document.getElementById("btnFb");
  if(btnF){
    btnF.onclick = () => {
      const g = guardValueCommerceOrAlert("facebook");
      if(!g.ok) return;

      const text = textarea.value || "";
      backupAndCopy(text);

      openOrPopup("https://www.facebook.com/", "FB");
    };
  }

  // Pinterest（VCはNG）
  const btnP = document.getElementById("btnPinterest");
  if(btnP){
    btnP.onclick = () => {
      const g = guardValueCommerceOrAlert("pinterest");
      if(!g.ok) return;

      const text = textarea.value.trim();
      const url = extractFirstUrl(text);
      if(!url) return;

      backupAndCopy(text);

      const pinterestUrl =
        "https://www.pinterest.com/pin-builder/?" +
        "url=" + encodeURIComponent(url) +
        "&description=" + encodeURIComponent(text);

      if(inAndroidApp){
        location.href = pinterestUrl;
        return;
      }
      safeWindowOpen(pinterestUrl, "SNS_PINTEREST");
    };
  }

  // 全SNSタブを閉じる（Webのみ）
  function closeAll(){
    [winX, winThreads, winBsky, winFb].forEach(w=>{
      if(w && !w.closed) w.close();
    });
  }

  const closeAllBtn = document.getElementById("closeAll");
  if(closeAllBtn){
    closeAllBtn.onclick = () => {
      if(inAndroidApp) return;
      closeAll();
      window.close();
    };
  }
  if(!inAndroidApp){
    window.addEventListener("beforeunload", closeAll);
  }

  /* =============================
     画像ペースト／ドラッグ＆ドロップ
============================= */
  function handleImageFile(file){
    if(!file || !file.type.startsWith("image/")) return;
    const reader=new FileReader();
    reader.onload=()=>{
      if(imageBox && imageBox.textContent.trim().startsWith("画像をペースト")){
        imageBox.textContent="";
      }
      const img=document.createElement("img");
      img.src=reader.result;
      imageBox.appendChild(img);
    };
    reader.readAsDataURL(file);
  }

  if(imageBox){
    imageBox.addEventListener("paste",e=>{
      const items=e.clipboardData && e.clipboardData.items;
      if(!items) return;
      for(const item of items){
        if(item.type && item.type.startsWith("image/")){
          handleImageFile(item.getAsFile());
          e.preventDefault();
          return;
        }
      }
    });
    imageBox.addEventListener("dragover",e=>e.preventDefault());
    imageBox.addEventListener("drop",e=>{
      e.preventDefault();
      const files=e.dataTransfer && e.dataTransfer.files;
      if(!files) return;
      for(const file of files) handleImageFile(file);
    });
  }
})();
</script>

</body>
</html>