<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>マルチSNS投稿ハブ（Amazon/Rakuten/Yahoo対応＋画像ペースト）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body{
    font-family:system-ui,sans-serif;
    margin:0;
    padding:14px;
    background:#fff;
  }
  .container{
    max-width:600px;
    margin:auto;
  }

  /* ====== ヘッダー（コンパクト） ====== */
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }
  .topbar h2{
    margin:0;
    font-size:1.05rem;
  }
  .icon-btn{
    width:auto;
    padding:6px 10px;
    font-size:1rem;
    border-radius:10px;
    border:1px solid #ddd;
    background:#f7f7f7;
    cursor:pointer;
  }

  /* ====== 折り畳み（詳細） ====== */
  details.advanced{
    border:1px solid #ddd;
    border-radius:10px;
    padding:8px 10px;
    margin-bottom:10px;
    background:#fff;
  }
  details.advanced summary{
    cursor:pointer;
    font-size:.95rem;
    color:#333;
  }

  textarea,input[type="text"]{
    width:100%;
    padding:10px;
    font-size:1rem;
    margin:10px 0;
    box-sizing:border-box;
  }
  textarea{
    height:120px;
  }

  /* ====== ボタン（小さめ） ====== */
  button{
    padding:10px 12px;
    margin:6px 0;
    font-size:1rem;
    cursor:pointer;
    width:100%;
    border-radius:12px;
    border:1px solid #ddd;
    background:#fff;
  }
  .btn-small{
    padding:8px 10px;
    font-size:.95rem;
  }
  .btn-primary{
    font-weight:700;
    border-color:#bbb;
    background:#f3f3f3;
  }
  .btn-danger{
    background:#ff4d4d;
    color:#fff;
    border-color:#ff4d4d;
  }

  /* ====== 画像ボックス（低め） ====== */
  .image-box{
    border:1px solid #ccc;
    border-radius:10px;
    padding:8px 10px;
    min-height:56px;
    font-size:.85rem;
    color:#555;
    background:#fafafa;
    overflow:auto;
    box-sizing:border-box;
  }
  .image-box img{
    max-width:100%;
    height:auto;
    display:block;
    margin-bottom:6px;
  }

  /* ====== 下部sticky操作バー ====== */
  .actionbar{
    position:sticky;
    bottom:0;
    background:#fff;
    padding:10px 0 6px;
    border-top:1px solid #ddd;
    margin-top:10px;
  }
  .actionbar .row{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px;
    align-items:stretch;
  }
  .actionbar .row + .row{
    margin-top:8px;
  }

  /* SNSボタンを2列グリッド化 */
  #snsButtons{
    display:none;
  }
  .sns-grid{
    display:grid;
    grid-template-columns: 1fr 1fr; /* 2列 */
    gap:8px;
  }
  .sns-btn{
    margin:0;
    padding:10px 8px;
    font-size:1rem;
    width:100%;
    border-radius:12px;
  }

  /* stickyが本文に被らない保険 */
  body{ padding-bottom:180px; }
</style>
</head>

<body>
<div class="container">

  <div class="topbar">
    <h2>PostHub</h2>
    <button id="helpBtn" class="icon-btn" type="button">ⓘ</button>
  </div>

  <!-- 詳細は折り畳み -->
  <details class="advanced" id="advancedBox">
    <summary>詳細</summary>

    <input type="text" id="urlInput" placeholder="URLだけ貼る（保険）">

    <button id="readClipboard" class="btn-small" style="display:none;">クリップボードから読み込む</button>

  </details>

  <button id="generate" class="btn-small">投稿文を生成</button>

  <textarea id="text" placeholder="本文（共有で入ります。追記してOK）"></textarea>

  <div id="imageBox" class="image-box">
    画像をペースト（Ctrl+V）またはドラッグ＆ドロップ（任意）
  </div>

  <!-- 下部sticky操作バー（投稿・クリア・閉じる＋SNS） -->
  <div class="actionbar">
    <div class="row">
      <button id="showSNS" class="btn-primary">投稿</button>
      <button id="clearDraft" style="display:none;background:#eee;">下書きクリア</button>
    </div>

    <div class="row">
      <button id="closeAll" class="btn-danger">すべて閉じる</button>
      <!-- 右側は空き：将来用（今は非表示にしないならダミー） -->
      <button type="button" style="visibility:hidden;">.</button>
    </div>

    <div id="snsButtons">
      <div class="sns-grid">
        <button class="sns-btn" id="btnX">X</button>
        <button class="sns-btn" id="btnThreads">Threads</button>
        <button class="sns-btn" id="btnBsky">Bluesky</button>
        <button class="sns-btn" id="btnFb">Facebook</button>
        <button class="sns-btn" id="btnPinterest">Pinterest</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =============================
   共通判定ユーティリティ
============================= */
function extractFirstUrl(text){
  return text.match(/https?:\/\/[^\s]+/i)?.[0] || "";
}

function isValueCommerce(url){
  return !!url && url.includes("ck.jp.ap.valuecommerce.com/servlet/");
}

function hasAmazonTag(url){
  return /[?&]tag=/.test(url);
}

function hasRakutenAff(url){
  return url.includes("rafcid=") ||
         url.includes("scid=af_") ||
         url.includes("hb.afl.rakuten.co.jp") ||
         url.includes("a.r10.to");
}

function isAmazon(url){
  return /amazon\.(co\.jp|jp|asia)/i.test(url) || /amzn\.(to|asia)/i.test(url);
}

function isRakuten(url){
  return /rakuten\.(co\.jp|ne\.jp)/i.test(url) || url.includes("a.r10.to") || url.includes("hb.afl.rakuten.co.jp");
}

function isYahoo(url){
  return url.includes("shopping.yahoo.co.jp") ||
         url.includes("store.shopping.yahoo.co.jp") ||
         url.includes("yahoo.jp/");
}

/**
 * Androidアプリ(WebView)内か判定：
 * いまの Android 側 Bridge に合わせて判定する
 *  - copyToClipboard / saveDraft / clearDraft があるか
 */
function isAndroidApp(){
  return typeof window.Android !== "undefined" &&
         typeof window.Android.copyToClipboard === "function" &&
         typeof window.Android.saveDraft === "function" &&
         typeof window.Android.clearDraft === "function";
}

(function(){
  let winX=null, winThreads=null, winBsky=null, winFb=null;

  const textarea=document.getElementById("text");
  const urlInput=document.getElementById("urlInput");
  const imageBox=document.getElementById("imageBox");

  const isAndroid = /Android/.test(navigator.userAgent);
  const inAndroidApp = isAndroidApp();

  /* -----------------------------
     ヘルプ（説明文は排除し、ⓘに集約）
  ----------------------------- */
  const helpBtn = document.getElementById("helpBtn");
  if(helpBtn){
    helpBtn.addEventListener("click", () => {
      alert(
        "使い方：\n" +
        "1) 共有→本文が入る\n" +
        "2) 必要なら追記して「投稿」\n" +
        "3) 各SNSを押して貼り付け（本文はコピーされます）\n\n" +
        "詳細（URL入力/クリップボード読込）は必要な時だけ開いてください。"
      );
    });
  }

  /* -----------------------------
     URLパラメータ（PCブックマークレット／Androidアプリからの ?text=）
  ----------------------------- */
  const params=new URLSearchParams(location.search);
  const textParam=params.get("text")||"";
  const sharedUrl=params.get("url")||"";
  const sharedText=params.get("text")||"";
  const sharedTitle=params.get("title")||"";

  // ===== 下書き（Web: localStorage / Android: SharedPreferences）=====
  // 仕様：B方式＝「投稿」ボタン押下時のみ保存
  // Web版だけ保険で localStorage を使う（Androidアプリは saveDraft に寄せる）
  const DRAFT_KEY = "posthub_draft_v2";

  function saveDraftWeb(text){
    try { localStorage.setItem(DRAFT_KEY, text); } catch(e) {}
  }
  function loadDraftWeb(){
    try { return localStorage.getItem(DRAFT_KEY) || ""; } catch(e){ return ""; }
  }
  function clearDraftWeb(){
    try { localStorage.removeItem(DRAFT_KEY); } catch(e) {}
  }

  // 初期表示：優先順位
  // 1) textParam（新しい共有が来た）
  // 2) sharedTitle/sharedText（PC用パラメータが来た）
  // 3) （Webのみ）localStorageの下書き
  // ※ Androidアプリは、起動時点で MainActivity が「下書き or 共有」を ?text= で渡してくる想定
  (function initTextarea(){
    if(textParam){
      textarea.value = textParam;
      return;
    }

    if(sharedTitle || sharedText){
      let combined="";
      if(sharedTitle) combined+=sharedTitle;
      if(sharedText){
        if(combined) combined+="\n";
        combined+=sharedText;
      }
      textarea.value=combined;
      return;
    }

    if(!inAndroidApp){
      const d = loadDraftWeb();
      if(d) textarea.value = d;
    }
  })();

  if(sharedUrl){
    urlInput.value=sharedUrl;
  }

  /* -----------------------------
     Amazonタイトル整形（必要なら）
  ----------------------------- */
  function cleanAmazonTitle(title){
    if(!title) return "";
    title = title.replace(/^Amazon\s*\|\s*/i, "");
    title = title.replace(/^Amazon\.co\.jp:\s*/i, "");
    title = title.replace(/\s*:\s*[^:]+$/i, "");
    let parts = title.split("|").map(s => s.trim());
    let product = parts[0] || "";
    let maker   = parts[1] || "";
    if (maker && product.includes(maker)) return product;
    if (maker) return maker + " " + product;
    return product;
  }

  /* -----------------------------
     Amazonタグ上書き（要件⑤）
  ----------------------------- */
  function overwriteAmazonTagToMine(url){
    try{
      const u = new URL(url);
      u.searchParams.set("tag", "yusatosh-22");
      return u.toString();
    }catch(e){
      return url;
    }
  }

  /* -----------------------------
     アフィリンク生成
  ----------------------------- */
  function generateAmazonLink(url){
    if(!isAmazon(url)) return null;

    // ASIN抽出（dp/gp/product）
    let asinMatch =
      url.match(/\/dp\/([A-Z0-9]{10})/i) ||
      url.match(/\/gp\/product\/([A-Z0-9]{10})/i);

    if(asinMatch){
      return "https://www.amazon.co.jp/dp/" + asinMatch[1] + "?tag=yusatosh-22";
    }

    // amzn.asia/d/xxxxx は ASIN 断定できないので無理に変換しない（A-1）
    // 最低限 tag を付ける（成果保証は弱い）
    if(hasAmazonTag(url)) return overwriteAmazonTagToMine(url);
    return overwriteAmazonTagToMine(url + (url.includes("?") ? "&" : "?") + "tag=yusatosh-22");
  }

  function generateRakutenLink(url){
    if(!isRakuten(url)) return null;

    // 既にアフィリならそのまま
    if(hasRakutenAff(url)) return url;

    // A方式：scid/rafcid 付与
    return url + (url.includes("?") ? "&" : "?") +
           "scid=af_pc_etc&rafcid=15844848.ec827d24.15844849.84443345";
  }

  function generateYahooLink(url){
    // Yahoo公式短縮リンクはそのまま
    if(url.includes("yahoo.jp/")) return url;

    if(url.includes("store.shopping.yahoo.co.jp") || url.includes("shopping.yahoo.co.jp")){
      return "https://ck.jp.ap.valuecommerce.com/servlet/referral" +
        "?sid=3672888&pid=888362937&vc_url=" + encodeURIComponent(url);
    }
    return null;
  }

  /* -----------------------------
     投稿文生成
  ----------------------------- */
  function generateFromURL(url, rawTitle){
    if(!url) return "";

    const mid = rawTitle ? (rawTitle + "\n\n") : "";

    if(isAmazon(url)){
      let aff = generateAmazonLink(url) || url;
      aff = overwriteAmazonTagToMine(aff);
      return "#密林偵察 #Amazonセール情報 #PR\n" + mid + aff;
    }

    if(isRakuten(url)){
      const aff = generateRakutenLink(url) || url;
      return "#楽天偵察 #PR\n" + mid + aff;
    }

    if(isYahoo(url)){
      const aff = generateYahooLink(url) || url;
      return "#Yahoo偵察 #PR\n" + mid + aff;
    }

    // 一般URL（ハッシュタグ無し）
    return rawTitle ? (rawTitle + "\n" + url) : url;
  }

  /* -----------------------------
     投稿文生成ボタン
  ----------------------------- */
  document.getElementById("generate").onclick = () => {
    const raw = textarea.value || "";
    let url = extractFirstUrl(raw);
    let title = "";

    if(raw.trim()){
      const firstLine = raw.split("\n")[0].trim();
      title = firstLine.replace(/https?:\/\/[^\s]+/g, "").trim();
      if(url && isAmazon(url)) title = cleanAmazonTitle(title);
      title = title.replace(/^\[楽天\]\s*/i, "");
    }

    if(!url) url = (urlInput.value || "").trim();
    if(!url) return;

    textarea.value = generateFromURL(url, title);

    applySnsVisibilityByCurrentText();
  };

  /* -----------------------------
     Pinterest ボタン表示制御（現状維持）
  ----------------------------- */
  function updatePinterestButtonVisibility(){
    const text = textarea.value.trim();
    const url = extractFirstUrl(text);
    const btn = document.getElementById("btnPinterest");

    if(!btn) return;

    if(!url){
      btn.style.display="none";
      return;
    }

    const isBlogger =
      url.includes("small-fishing.com") ||
      url.includes("fishingtonpuku.blogspot.com") ||
      url.includes("tonpuku3fishing.blogspot.com");

    if(isRakuten(url) || isBlogger){
      btn.style.display="block";
    }else{
      btn.style.display="none";
    }
  }

  textarea.addEventListener("input", () => {
    updatePinterestButtonVisibility();
  });

  /* -----------------------------
     画像ペースト／ドラッグ＆ドロップ
  ----------------------------- */
  function handleImageFile(file){
    if(!file || !file.type.startsWith("image/")) return;
    const reader=new FileReader();
    reader.onload=()=>{
      if(imageBox && imageBox.textContent.trim().startsWith("画像をペースト")){
        imageBox.textContent="";
      }
      const img=document.createElement("img");
      img.src=reader.result;
      imageBox.appendChild(img);
    };
    reader.readAsDataURL(file);
  }

  if(imageBox){
    imageBox.addEventListener("paste",e=>{
      const items=e.clipboardData && e.clipboardData.items;
      if(!items) return;
      for(const item of items){
        if(item.type && item.type.startsWith("image/")){
          handleImageFile(item.getAsFile());
          e.preventDefault();
          return;
        }
      }
    });
    imageBox.addEventListener("dragover",e=>e.preventDefault());
    imageBox.addEventListener("drop",e=>{
      e.preventDefault();
      const files=e.dataTransfer && e.dataTransfer.files;
      if(!files) return;
      for(const file of files) handleImageFile(file);
    });
  }

  /* -----------------------------
     Android向け readClipboard（任意）
  ----------------------------- */
  if (isAndroid) {
    const readBtn = document.getElementById("readClipboard");
    if(readBtn) readBtn.style.display = "block";
  }

  const readClipboardBtn = document.getElementById("readClipboard");
  if(readClipboardBtn){
    readClipboardBtn.addEventListener("click", () => {
      navigator.clipboard.readText()
        .then(text => { textarea.value = text || ""; applySnsVisibilityByCurrentText(); })
        .catch(() => alert("クリップボードの読み取りが許可されていません"));
    });
  }

  /* -----------------------------
     Web/Androidでボタン表示を変える
  ----------------------------- */

  // Androidでは「すべて閉じる」を隠す（あなたの提案）
  if (isAndroid) {
    const closeBtn = document.getElementById("closeAll");
    if (closeBtn) closeBtn.style.display = "none";
  }

  // Androidだけ「クリア」を表示
  const clearBtn = document.getElementById("clearDraft");
  if (isAndroid && clearBtn) {
    clearBtn.style.display = "block";
    clearBtn.addEventListener("click", () => {
      textarea.value = "";
      urlInput.value = "";
      const sns = document.getElementById("snsButtons");
      if(sns) sns.style.display = "none";

      if(inAndroidApp){
        try { window.Android.clearDraft(); } catch(e){}
      }else{
        clearDraftWeb();
      }
      applySnsVisibilityByCurrentText();
      alert("下書きをクリアしました");
    });
  }

  /* -----------------------------
     SNSボタン表示制御
     - ValueCommerceならX以外を隠す
  ----------------------------- */
  function applySnsVisibilityByCurrentText(){
    const text = textarea.value || "";
    const url = extractFirstUrl(text);

    const isVC = url && isValueCommerce(url);

    const t = document.getElementById("btnThreads");
    const b = document.getElementById("btnBsky");
    const f = document.getElementById("btnFb");
    const p = document.getElementById("btnPinterest");

    if(t) t.style.display="block";
    if(b) b.style.display="block";
    if(f) f.style.display="block";
    if(p) p.style.display="block";

    if(isVC){
      if(t) t.style.display="none";
      if(b) b.style.display="none";
      if(f) f.style.display="none";
      if(p) p.style.display="none";
    }

    updatePinterestButtonVisibility();
  }

  /* -----------------------------
     「投稿」ボタン：B方式でここでだけ保存
  ----------------------------- */
  const showBtn = document.getElementById("showSNS");
  if(showBtn){
    showBtn.onclick = () => {
      // 1) B方式：投稿ボタン押下時だけ保存
      if(inAndroidApp){
        try { window.Android.saveDraft(textarea.value); } catch(e){}
      }else{
        saveDraftWeb(textarea.value);
      }

      // 2) クリップボードへ（任意）
      navigator.clipboard.writeText(textarea.value).catch(()=>{});

      // 3) VCならボタン制限
      applySnsVisibilityByCurrentText();

      // 4) SNSボタン表示
      const sns = document.getElementById("snsButtons");
      if(sns) sns.style.display="block";
    };
  }

  /* -----------------------------
     SNS起動
     - Androidアプリ内：コピーして location.href（WebViewClientが外に出す）
     - Web：window.open
     ※ 重要：いまのAndroid側には openApp が無いのでJSからは呼ばない
  ----------------------------- */
  function openOrPopup(url, winRefName){
    if(inAndroidApp){
      try{ window.Android.copyToClipboard(textarea.value); }catch(e){}
      location.href = url;
      return;
    }

    let w = null;
    if(winRefName === "X") w = winX;
    if(winRefName === "TH") w = winThreads;
    if(winRefName === "BSKY") w = winBsky;
    if(winRefName === "FB") w = winFb;

    if(!w || w.closed){
      w = window.open(url, "SNS_" + winRefName);
    }else{
      try{ w.location.href = url; w.focus(); }
      catch(e){ w.close(); w = window.open(url, "SNS_" + winRefName); }
    }

    if(winRefName === "X") winX = w;
    if(winRefName === "TH") winThreads = w;
    if(winRefName === "BSKY") winBsky = w;
    if(winRefName === "FB") winFb = w;
  }

  const btnX = document.getElementById("btnX");
  if(btnX){
    btnX.onclick = () => {
      const text = textarea.value || "";
      const url = "https://x.com/intent/post?text=" + encodeURIComponent(text);
      openOrPopup(url, "X");
    };
  }

  const btnThreads = document.getElementById("btnThreads");
  if(btnThreads){
    btnThreads.onclick = () => {
      openOrPopup("https://www.threads.net/intent/post", "TH");
    };
  }

  const btnB = document.getElementById("btnBsky");
  if(btnB){
    btnB.onclick = () => {
      openOrPopup("https://bsky.app", "BSKY");
    };
  }

  const btnF = document.getElementById("btnFb");
  if(btnF){
    btnF.onclick = () => {
      openOrPopup("https://www.facebook.com/", "FB");
    };
  }

  const btnP = document.getElementById("btnPinterest");
  if(btnP){
    btnP.onclick = () => {
      const text = textarea.value.trim();
      const url = extractFirstUrl(text);
      if(!url) return;

      const pinterestUrl =
        "https://www.pinterest.com/pin-builder/?" +
        "url=" + encodeURIComponent(url) +
        "&description=" + encodeURIComponent(text);

      if(inAndroidApp){
        try{ window.Android.copyToClipboard(textarea.value); }catch(e){}
        location.href = pinterestUrl;
        return;
      }

      window.open(pinterestUrl, "SNS_PINTEREST");
    };
  }

  /* -----------------------------
     全SNSタブを閉じる（Web用のみ）
  ----------------------------- */
  function closeAll(){
    [winX, winThreads, winBsky, winFb].forEach(w=>{
      if(w && !w.closed) w.close();
    });
  }

  const closeAllBtn = document.getElementById("closeAll");
  if(closeAllBtn){
    closeAllBtn.onclick = () => {
      if(inAndroidApp){
        return;
      }
      closeAll();
      window.close();
    };
  }

  if(!inAndroidApp){
    window.addEventListener("beforeunload", closeAll);
  }

  // 初期反映
  applySnsVisibilityByCurrentText();
})();
</script>

</body>
</html>
