<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>マルチSNS投稿ハブ（Amazon/Rakuten/Yahoo対応＋画像ペースト）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:system-ui,sans-serif;
  margin:0;
  padding:20px;
  background:#fff;
}
.container{
  max-width:600px;
  margin:auto;
}
textarea,input[type="text"]{
  width:100%;
  padding:10px;
  font-size:1rem;
  margin-bottom:10px;
}
textarea{
  height:150px;
}
button{
  padding:12px 16px;
  margin:6px 0;
  font-size:1.1rem;
  cursor:pointer;
  width:100%;
}
#snsButtons{
  margin-top:20px;
  display:none;
}
.sns-btn{
  margin-bottom:10px;
}
.note{
  font-size:.85rem;
  color:#555;
  margin-bottom:8px;
}
.image-note{
  font-size:.85rem;
  color:#555;
  margin:8px 0 4px;
}
.image-box{
  border:1px solid #ccc;
  border-radius:4px;
  padding:10px;
  min-height:80px;
  font-size:.9rem;
  color:#555;
  background:#fafafa;
  overflow:auto;
}
.image-box img{
  max-width:100%;
  height:auto;
  display:block;
  margin-bottom:6px;
}
</style>
</head>

<body>
<div class="container">
  <h2>マルチSNS投稿ハブ</h2>

  <div class="note">
    PC：ブックマークレットから開くとタイトル＋URLが自動で入ります。<br>
    Android：共有メニューから「投稿ハブ」を選ぶとURLが自動入力されます。
  </div>

  <input type="text" id="urlInput" placeholder="スマホではここに商品URLが自動入力されます（Amazon / Rakuten / Yahoo）">

  <button id="readClipboard" style="display:none;">クリップボードから読み込む</button>

  <button id="generate">投稿文を生成</button>

  <textarea id="text" placeholder="PCではここにタイトル＋URLが入ります。スマホでは任意で紹介文を書き足してもOKです。"></textarea>

  <div class="image-note">
    検索結果やキャンペーン画面のスクショなど、アイキャッチにしたい画像をここにペースト（Ctrl+V）またはドラッグ＆ドロップしてください。<br>
    各SNSの投稿画面が開いたら、本文をペーストした後に画像も Ctrl+V で貼り付けてください。
  </div>

  <div id="imageBox" class="image-box">
    ここに画像をペースト（Ctrl+V）またはドラッグ＆ドロップ
  </div>

  <button id="showSNS">投稿</button>
  <button id="closeAll" style="background:#ff4d4d;color:#fff;">すべて閉じる</button>

  <div id="snsButtons">
    <button class="sns-btn" id="btnX">X に投稿</button>
    <button class="sns-btn" id="btnThreads">Threads に投稿</button>
    <button class="sns-btn" id="btnBsky">Bluesky に投稿</button>
    <button class="sns-btn" id="btnFb">Facebook に投稿</button>
    <button class="sns-btn" id="btnPinterest">Pinterest に投稿</button>
  </div>
</div>
  
<script>
/* =============================
   共通判定ユーティリティ
============================= */
function extractFirstUrl(text){
  return text.match(/https?:\/\/[^\s]+/i)?.[0] || "";
}

function isValueCommerce(url){
  return url.includes("ck.jp.ap.valuecommerce.com/servlet/");
}

function hasAmazonTag(url){
  return /[?&]tag=/.test(url);
}

function hasRakutenAff(url){
  return url.includes("rafcid=") || url.includes("scid=af_") || url.includes("hb.afl.rakuten.co.jp") || url.includes("a.r10.to");
}

function isAmazon(url){
  return /amazon\.(co\.jp|jp|asia)/i.test(url) || /amzn\.(to|asia)/i.test(url);
}

function isRakuten(url){
  return /rakuten\.(co\.jp|ne\.jp)/i.test(url) || url.includes("a.r10.to") || url.includes("hb.afl.rakuten.co.jp");
}

function isYahoo(url){
  return url.includes("shopping.yahoo.co.jp") ||
         url.includes("store.shopping.yahoo.co.jp") ||
         url.includes("yahoo.jp/");
}

// Androidアプリ(WebView)内か判定：JavascriptInterface "Android" がいるかどうかで判定
function hasAndroidBridge(){
  return typeof window.Android !== "undefined" &&
         typeof window.Android.copyToClipboard === "function" &&
         typeof window.Android.openApp === "function";
}

// 外部アプリ優先で開く（Androidアプリ内だけ）
function openExternal(app, url, textToCopy){
  if(hasAndroidBridge()){
    try{
      if(textToCopy) Android.copyToClipboard(textToCopy);
      Android.openApp(app, url);
      return true;
    }catch(e){
      // 失敗したらWeb fallback
    }
  }
  return false;
}

(function(){
  let winX=null, winThreads=null, winBsky=null, winFb=null;
  const textarea=document.getElementById("text");
  const urlInput=document.getElementById("urlInput");
  const imageBox=document.getElementById("imageBox");

  /* -----------------------------
     URLパラメータ（PCブックマークレット用）
  ----------------------------- */
  const params=new URLSearchParams(location.search);
  const textParam=params.get("text")||"";
  const sharedUrl=params.get("url")||"";
  const sharedText=params.get("text")||"";
  const sharedTitle=params.get("title")||"";

  if(textParam){
    textarea.value=textParam;
  }else if(sharedTitle || sharedText){
    let combined="";
    if(sharedTitle) combined+=sharedTitle;
    if(sharedText){
      if(combined) combined+="\n";
      combined+=sharedText;
    }
    textarea.value=combined;
  }
  if(sharedUrl){
    urlInput.value=sharedUrl;
  }

  /* -----------------------------
     Amazonタイトル整形（必要なら）
  ----------------------------- */
  function cleanAmazonTitle(title){
    if(!title) return "";
    title = title.replace(/^Amazon\s*\|\s*/i, "");
    title = title.replace(/^Amazon\.co\.jp:\s*/i, "");
    title = title.replace(/\s*:\s*[^:]+$/i, "");
    let parts = title.split("|").map(s => s.trim());
    let product = parts[0] || "";
    let maker   = parts[1] || "";
    if (maker && product.includes(maker)) return product;
    if (maker) return maker + " " + product;
    return product;
  }

  /* -----------------------------
     アフィリンク生成
  ----------------------------- */
  function generateAmazonLink(url){
    if(!isAmazon(url)) return null;

    // 既に自分のtagが付いてるならそのまま
    // （他人tagでも上書きしたい要件があるので、あとで上書き処理）
    // まずは後段で統一するためここでは「tag付きはそのまま返す」
    if(hasAmazonTag(url)) return url;

    // ASIN抽出（dp/gp/product）
    let asinMatch =
      url.match(/\/dp\/([A-Z0-9]{10})/i) ||
      url.match(/\/gp\/product\/([A-Z0-9]{10})/i);

    if(asinMatch){
      return "https://www.amazon.co.jp/dp/" + asinMatch[1] + "?tag=yusatosh-22";
    }

    // amzn.asia/d/xxxxx は ASINとは限らないため、ここでは無理に変換しない
    // とりあえずtag付与で最低限（ただし成果になる保証は薄い）
    return url + (url.includes("?") ? "&" : "?") + "tag=yusatosh-22";
  }

  function overwriteAmazonTagToMine(url){
    // 既存tagを自分tagに強制上書き（要件⑤）
    try{
      const u = new URL(url);
      u.searchParams.set("tag", "yusatosh-22");
      return u.toString();
    }catch(e){
      // URLとしてパースできない場合はそのまま
      return url;
    }
  }

  function generateRakutenLink(url){
    if(!isRakuten(url)) return null;

    // 既に楽天アフィリ（hb.afl / a.r10.to / rafcid 等）ならそのまま
    if(hasRakutenAff(url)) return url;

    // A方式：まずは最小で scid/rafcid を付与（※楽天側仕様の揺れはある）
    // 既存のあなたのIDを使う（要件：ソースから読める）
    return url + (url.includes("?") ? "&" : "?") +
           "scid=af_pc_etc&rafcid=15844848.ec827d24.15844849.84443345";
  }

  function generateYahooLink(url){
    // Yahoo公式短縮リンクはそのまま（あなたの説明通り）
    if(url.includes("yahoo.jp/")) return url;

    // ValueCommerce形式に変換
    if(url.includes("store.shopping.yahoo.co.jp") || url.includes("shopping.yahoo.co.jp")){
      return "https://ck.jp.ap.valuecommerce.com/servlet/referral" +
        "?sid=3672888&pid=888362937&vc_url=" + encodeURIComponent(url);
    }
    return null;
  }

  /* -----------------------------
     投稿文生成
     ルール：
     - 既存テキスト(rawTitle)があるなら、#タグ と URL の間に残す（要件④）
     - Amazon/Yahoo/Rakuten は #AD → #PR
  ----------------------------- */
  function generateFromURL(url, rawTitle){
    if(!url) return "";

    // rawTitle は「共有文の1行目」など。ここではそのまま残す（細かな除去は後で仕様化）
    const mid = rawTitle ? (rawTitle + "\n\n") : "";

    if(isAmazon(url)){
      let aff = generateAmazonLink(url);
      if(!aff) aff = url;
      // tag上書き（要件⑤）
      aff = overwriteAmazonTagToMine(aff);

      return "#密林偵察 #Amazonセール情報 #PR\n" +
             mid +
             aff;
    }

    if(isRakuten(url)){
      const aff = generateRakutenLink(url) || url;
      return "#楽天偵察 #PR\n" +
             mid +
             aff;
    }

    if(isYahoo(url)){
      const aff = generateYahooLink(url) || url;
      return "#Yahoo偵察 #PR\n" +
             mid +
             aff;
    }

    // 一般URL（要件：ハッシュタグ無し）
    return rawTitle ? (rawTitle + "\n" + url) : url;
  }

  /* -----------------------------
     投稿文生成ボタン
     ※ あなたの要件で「現行の2行前提は無視」→ URLは本文内から拾う
  ----------------------------- */
  document.getElementById("generate").onclick = () => {
    const raw = textarea.value || "";
    let url = extractFirstUrl(raw);
    let title = "";

    // title はURLを除いた先頭行を使う（共有文が「文章＋URL」でも拾える）
    if(raw.trim()){
      const firstLine = raw.split("\n")[0].trim();
      title = firstLine.replace(/https?:\/\/[^\s]+/g, "").trim();
      // Amazonの場合だけ整形してもよい（現状維持）
      if(isAmazon(url)) title = cleanAmazonTitle(title);
      // 楽天アプリの [楽天] などは残す/削るは後で仕様、いったん軽く削る
      title = title.replace(/^\[楽天\]\s*/i, "");
    }

    if(!url) url = (urlInput.value || "").trim();
    if(!url) return;

    textarea.value = generateFromURL(url, title);

    // Pinterest表示制御などの更新
    updatePinterestButtonVisibility();
  };

  /* -----------------------------
     Pinterest ボタン表示制御（現状維持＋微調整）
  ----------------------------- */
  function updatePinterestButtonVisibility(){
    const text = textarea.value.trim();
    const url = extractFirstUrl(text);
    const btn = document.getElementById("btnPinterest");

    if(!url){
      btn.style.display="none";
      return;
    }

    const isBlogger =
      url.includes("small-fishing.com") ||
      url.includes("fishingtonpuku.blogspot.com") ||
      url.includes("tonpuku3fishing.blogspot.com");

    // 楽天 or Blogger は表示、それ以外は非表示（現行方針）
    if(isRakuten(url) || isBlogger){
      btn.style.display="block";
    }else{
      btn.style.display="none";
    }
  }
  textarea.addEventListener("input", updatePinterestButtonVisibility);

  /* -----------------------------
     画像ペースト／ドラッグ＆ドロップ（現状維持）
  ----------------------------- */
  function handleImageFile(file){
    if(!file || !file.type.startsWith("image/")) return;
    const reader=new FileReader();
    reader.onload=()=>{
      if(imageBox.textContent.trim().startsWith("ここに画像をペースト")){
        imageBox.textContent="";
      }
      const img=document.createElement("img");
      img.src=reader.result;
      imageBox.appendChild(img);
    };
    reader.readAsDataURL(file);
  }

  imageBox.addEventListener("paste",e=>{
    const items=e.clipboardData && e.clipboardData.items;
    if(!items) return;
    for(const item of items){
      if(item.type && item.type.startsWith("image/")){
        handleImageFile(item.getAsFile());
        e.preventDefault();
        return;
      }
    }
  });
  imageBox.addEventListener("dragover",e=>e.preventDefault());
  imageBox.addEventListener("drop",e=>{
    e.preventDefault();
    const files=e.dataTransfer && e.dataTransfer.files;
    if(!files) return;
    for(const file of files) handleImageFile(file);
  });

  /* -----------------------------
     Android向け readClipboard（現状維持）
  ----------------------------- */
  const isAndroid = /Android/.test(navigator.userAgent);
  if (isAndroid) document.getElementById("readClipboard").style.display = "block";

  document.getElementById("readClipboard").addEventListener("click", () => {
    navigator.clipboard.readText()
      .then(text => { textarea.value = text || ""; })
      .catch(() => alert("クリップボードの読み取りが許可されていません"));
  });

  /* -----------------------------
     SNSボタン表示（ValueCommerceならX以外を隠す）
  ----------------------------- */
  function applySnsVisibilityByCurrentText(){
    const text = textarea.value || "";
    const url = extractFirstUrl(text);

    const isVC = url && isValueCommerce(url);

    // まず全部出す
    document.getElementById("btnThreads").style.display="block";
    document.getElementById("btnBsky").style.display="block";
    document.getElementById("btnFb").style.display="block";
    document.getElementById("btnPinterest").style.display="block";

    // VCならX以外を隠す（要件⑤）
    if(isVC){
      document.getElementById("btnThreads").style.display="none";
      document.getElementById("btnBsky").style.display="none";
      document.getElementById("btnFb").style.display="none";
      document.getElementById("btnPinterest").style.display="none";
    }

    // Pinterestは別ルールでも制御
    updatePinterestButtonVisibility();
  }

  document.getElementById("showSNS").onclick = () => {
    // ③のタイミングで下書き保存（ネイティブ側に保持）
    if (window.Android && Android.saveDraft) {
      Android.saveDraft(textarea.value);
    }
  
    // クリップボードコピー等、既存処理
    if (window.Android && Android.copyToClipboard) {
      Android.copyToClipboard(textarea.value);
    } else {
      navigator.clipboard.writeText(textarea.value).catch(()=>{});
    }
  
    document.getElementById("snsButtons").style.display="block";
  };
    
  /* -----------------------------
     SNS起動：Androidアプリ内なら外部アプリ優先
     それ以外は従来通り window.open
  ----------------------------- */

  // X
  document.getElementById("btnX").onclick = () => {
    const text = textarea.value || "";
    const url = "https://x.com/intent/post?text=" + encodeURIComponent(text);

    // Androidアプリ内：コピー→外部アプリ起動
    if(openExternal("x", url, text)) return;

    // Web fallback
    if(!winX || winX.closed){
      winX = window.open(url, "SNS_X");
    }else{
      try{ winX.location.href = url; winX.focus(); }
      catch(e){ winX.close(); winX = window.open(url, "SNS_X"); }
    }
  };

  // Threads（本文URL注入は期待できないので、コピー→起動）
  document.getElementById("btnThreads").onclick = () => {
    const text = textarea.value || "";
    const url = "https://www.threads.net/intent/post";

    if(openExternal("threads", url, text)) return;

    if(winThreads && !winThreads.closed) winThreads.close();
    winThreads = window.open(url, "SNS_THREADS");
  };

  // Bluesky（コピー→起動）
  document.getElementById("btnBsky").onclick = () => {
    const text = textarea.value || "";
    const url = "https://bsky.app";

    if(openExternal("bsky", url, text)) return;

    if(!winBsky || winBsky.closed){
      winBsky = window.open(url, "SNS_BSKY");
    }else{
      try{ winBsky.location.href = url; winBsky.focus(); }
      catch(e){ winBsky.close(); winBsky = window.open(url, "SNS_BSKY"); }
    }
  };

  // Facebook（コピー→起動）
  document.getElementById("btnFb").onclick = () => {
    const text = textarea.value || "";
    const url = "https://www.facebook.com/";

    if(openExternal("facebook", url, text)) return;

    if(winFb && !winFb.closed) winFb.close();
    winFb = window.open(url, "SNS_FB");
  };

  // Pinterest（コピー→起動、Web fallbackは現行のpin-builder）
  document.getElementById("btnPinterest").onclick = () => {
    const text = textarea.value.trim();
    const url = extractFirstUrl(text);
    if(!url) return;

    const pinterestUrl =
      "https://www.pinterest.com/pin-builder/?" +
      "url=" + encodeURIComponent(url) +
      "&description=" + encodeURIComponent(text);

    if(openExternal("pinterest", pinterestUrl, text)) return;

    window.open(pinterestUrl, "SNS_PINTEREST");
  };

  /* -----------------------------
     全SNSタブを閉じる（Web用）
  ----------------------------- */
  function closeAll(){
    [winX, winThreads, winBsky, winFb].forEach(w=>{
      if(w && !w.closed) w.close();
    });
  }

  document.getElementById("closeAll").onclick = () => {
    closeAll();
      // Androidアプリ内なら閉じない（アプリが消えるのを防ぐ）
  if (typeof window.Android !== "undefined") return;

    window.close();
  };
if (typeof window.Android === "undefined") {
  window.addEventListener("beforeunload", closeAll);
}

})();
</script>

</body>
</html>
