<script>
(function(){

  let winX=null, winThreads=null, winBsky=null, winFb=null;
  const textarea=document.getElementById("text");
  const urlInput=document.getElementById("urlInput");
  const imageBox=document.getElementById("imageBox");

  /* -----------------------------
     URLパラメータ（PCブックマークレット用）
  ----------------------------- */
  const params=new URLSearchParams(location.search);
  const textParam=params.get("text")||"";
  const sharedUrl=params.get("url")||"";
  const sharedText=params.get("text")||"";
  const sharedTitle=params.get("title")||"";

  if(textParam){
    textarea.value=textParam;
  }else if(sharedTitle || sharedText){
    let combined="";
    if(sharedTitle) combined+=sharedTitle;
    if(sharedText){
      if(combined) combined+="\n";
      combined+=sharedText;
    }
    textarea.value=combined;
  }

  if(sharedUrl){
    urlInput.value=sharedUrl;
  }

  /* -----------------------------
     Amazonタイトル整形
  ----------------------------- */
  function cleanAmazonTitle(title){
    if(!title) return "";

    title = title.replace(/^Amazon\s*\|\s*/i, "");
    title = title.replace(/^Amazon\.co\.jp:\s*/i, "");
    title = title.replace(/\s*:\s*[^:]+$/i, "");

    let parts = title.split("|").map(s => s.trim());
    let product = parts[0] || "";
    let maker   = parts[1] || "";

    if (maker && product.includes(maker)) return product;
    if (maker) return maker + " " + product;
    return product;
  }

  /* -----------------------------
     アフィリンク生成
  ----------------------------- */
  function generateAmazonLink(url){
    if(!url.includes("amazon.co.jp")) return null;

    let asin=null;
    let m1=url.match(/\/dp\/([A-Z0-9]{10})/i);
    let m2=url.match(/\/gp\/product\/([A-Z0-9]{10})/i);
    let m3=url.match(/\/product\/([A-Z0-9]{10})/i);
    if(m1) asin=m1[1];
    if(m2) asin=m2[1];
    if(m3) asin=m3[1];

    if(asin){
      return "https://www.amazon.co.jp/dp/"+asin+"?tag=yusatosh-22";
    }
    return url+(url.includes("?")?"&":"?")+"tag=yusatosh-22";
  }

  function generateRakutenLink(url){
    if(!/rakuten\.(co\.jp|ne\.jp)/.test(url)) return null;
    let base="https://hb.afl.rakuten.co.jp/hgc/15844848.ec827d24.15844849.84443345/";
    return base+"?pc="+encodeURIComponent(url)+"&link_type=hybrid_url";
  }

  function generateYahooLink(url){
    if(
      url.includes("store.shopping.yahoo.co.jp") ||
      (url.includes("shopping.yahoo.co.jp") &&
       (url.includes("/search") || url.includes("/promotion") || url.includes("/product")))
    ){
      return "https://ck.jp.ap.valuecommerce.com/servlet/referral?sid=3672888&pid=888362937&vc_url=" + encodeURIComponent(url);
    }
    return null;
  }

  /* -----------------------------
     URL＋タイトル → 投稿文生成
  ----------------------------- */
  function generateFromURL(url,rawTitle){
    if(!url) return "";

    let amazon=generateAmazonLink(url);
    if(amazon){
      let title=cleanAmazonTitle(rawTitle);
      return "#密林偵察 #Amazonセール情報 #AD\n" +
             (title ? title+"\n" : "") +
             amazon;
    }

    let rakuten=generateRakutenLink(url);
    if(rakuten){
      return "#楽天偵察 #セール情報 #AD\n" +
             (rawTitle ? rawTitle+"\n" : "") +
             rakuten;
    }

    let yahoo=generateYahooLink(url);
    if(yahoo){
      return "#Yahoo偵察 #AD\n" +
             (rawTitle ? rawTitle+"\n" : "") +
             yahoo;
    }

    return rawTitle ? rawTitle+"\n"+url : url;
  }

  /* -----------------------------
     投稿文生成ボタン
  ----------------------------- */
  document.getElementById("generate").onclick=()=>{
    let raw=textarea.value.trim();
    let title="", url="";

    if(raw){
      let lines=raw.split("\n");
      if(lines.length>=2){
        title=lines[0].trim();
        url=lines[1].trim();
      }
    }

    if(!url) url=urlInput.value.trim();
    if(!url) return;

    if(generateYahooLink(url)){
      document.getElementById("btnThreads").style.display="none";
      document.getElementById("btnBsky").style.display="none";
      document.getElementById("btnFb").style.display="none";
    }else{
      document.getElementById("btnThreads").style.display="block";
      document.getElementById("btnBsky").style.display="block";
      document.getElementById("btnFb").style.display="block";
    }

    textarea.value=generateFromURL(url,title);
  };

  /* -----------------------------
     SNS投稿ボタン
  ----------------------------- */
  document.getElementById("showSNS").onclick=async()=>{
    try{ await navigator.clipboard.writeText(textarea.value); }catch(e){}
    document.getElementById("snsButtons").style.display="block";
  };

  /* ---- X（再利用可能） ---- */
  document.getElementById("btnX").onclick=()=>{
    const url="https://twitter.com/intent/tweet?text="+encodeURIComponent(textarea.value);

    if(!winX || winX.closed){
      winX = window.open(url, "SNS_X");
    }else{
      winX.location.href = url;
      winX.focus();
    }
    if(winX) winX.opener=null;
  };

  /* ---- Threads（opener切断 → 再利用不可 → 毎回閉じて開く） ---- */
  document.getElementById("btnThreads").onclick=()=>{
    if(winThreads && !winThreads.closed) winThreads.close();
    winThreads = window.open("https://www.threads.net/intent/post", "SNS_THREADS");
    if(winThreads) winThreads.opener=null;
  };

  /* ---- Bluesky（再利用可能） ---- */
  document.getElementById("btnBsky").onclick=()=>{
    const url="https://bsky.app";

    if(!winBsky || winBsky.closed){
      winBsky = window.open(url, "SNS_BSKY");
    }else{
      winBsky.location.href = url;
      winBsky.focus();
    }
    if(winBsky) winBsky.opener=null;
  };

  /* ---- Facebook（opener切断 → 再利用不可 → 毎回閉じて開く） ---- */
  document.getElementById("btnFb").onclick=()=>{
    if(winFb && !winFb.closed) winFb.close();
    winFb = window.open("https://www.facebook.com/home.php", "SNS_FB");
    if(winFb) winFb.opener=null;
  };

  /* ---- 全SNSタブを閉じる ---- */
  function closeAll(){
    [winX,winThreads,winBsky,winFb].forEach(w=>{
      if(w && !w.closed) w.close();
    });
  }
  document.getElementById("closeAll").onclick=()=>{
    closeAll();
    window.close();
  };
  window.addEventListener("beforeunload",closeAll);

  /* -----------------------------
     画像ペースト／ドラッグ＆ドロップ
  ----------------------------- */
  function handleImageFile(file){
    if(!file || !file.type.startsWith("image/")) return;
    const reader=new FileReader();
    reader.onload=()=>{
      if(imageBox.textContent.trim().startsWith("ここに画像をペースト")){
        imageBox.textContent="";
      }
      const img=document.createElement("img");
      img.src=reader.result;
      imageBox.appendChild(img);
    };
    reader.readAsDataURL(file);
  }

  imageBox.addEventListener("paste",e=>{
    const items=e.clipboardData && e.clipboardData.items;
    if(!items) return;
    for(const item of items){
      if(item.type && item.type.startsWith("image/")){
        handleImageFile(item.getAsFile());
        e.preventDefault();
        return;
      }
    }
  });

  imageBox.addEventListener("dragover",e=>e.preventDefault());
  imageBox.addEventListener("drop",e=>{
    e.preventDefault();
    const files=e.dataTransfer && e.dataTransfer.files;
    if(!files) return;
    for(const file of files) handleImageFile(file);
  });

  /* -----------------------------
     Android向け readText
  ----------------------------- */
  const ua = navigator.userAgent;
  const isAndroid = /Android/.test(ua);

  if (isAndroid) {
    document.getElementById("readClipboard").style.display = "block";
  }

  document.getElementById("readClipboard").addEventListener("click", () => {
    navigator.clipboard.readText()
      .then(text => processSharedText(text))
      .catch(() => alert("クリップボードの読み取りが許可されていません"));
  });

  function processSharedText(text){
    if(!text) return;

    const url = text.match(/https?:\/\/[^\s]+/i)?.[0] || "";
    if(!url){
      alert("URLが見つかりませんでした");
      return;
    }

    let firstLine = text.split("\n")[0].trim();
    firstLine = firstLine.replace(/https?:\/\/[^\s]+/g, "").trim();

    if(url.includes("amzn.to") || url.includes("amzn.asia")){
      textarea.value =
        "#密林偵察 #Amazonセール情報 #AD\n" +
        firstLine + "\n" +
        url.trim();
      return;
    }

    if(url.includes("amazon.co.jp")){
      const clean = cleanAmazonTitle(firstLine);
      const aff = generateAmazonLink(url);
      textarea.value =
        "#密林偵察 #Amazonセール情報 #AD\n" +
        clean + "\n" +
        aff;
      return;
    }

    if(/rakuten\.(co\.jp|ne\.jp)/.test(url)){
      const cleanTitle = firstLine.replace(/^\[楽天\]\s*/i, "");
      const aff = generateRakutenLink(url);
      textarea.value =
        "#楽天偵察 #セール情報 #AD\n" +
        cleanTitle + "\n" +
        aff;
      return;
    }

    if(url.includes("shopping.yahoo.co.jp") || url.includes("store.shopping.yahoo.co.jp")){
      const aff = generateYahooLink(url);
      textarea.value =
        "#Yahoo偵察 #AD\n" +
        firstLine + "\n" +
        aff;
      return;
    }

    textarea.value = firstLine + "\n" + url;
  }

})();
</script>
